<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PadelinAja — Register</title>
    {% load static %} {# Load static files tag #}

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root{
          --white:#f9f6f6;
          --purple:#58239f;
          --yellow:#ffec58;
          --black:#000000;
          --muted:#6b7280;
          --border:#e5e7eb;
          --ring:#e6e0f4;
          --shadow:0 10px 30px rgba(0,0,0,.08);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
          margin:0;
          font-family:'Lato',sans-serif;
          background:var(--white);
          color:var(--black);
        }
        .page{
          display:grid;
          grid-template-columns:min(700px,100%) 1fr;
          min-height:100vh;
          align-items:center;
        }
        @media(max-width:960px){
          .page{grid-template-columns:1fr}
          .hero{display:none}
        }
        .panel{
          display:flex;align-items:center;justify-content:center;
          padding:48px 24px;
        }
        .card{
          width:min(580px,100%);
          background:#fff;
          border-radius:20px;
          border:1px solid var(--border);
          box-shadow:var(--shadow);
          padding:40px 36px;
        }
        .hero{
          display:flex;align-items:center;justify-content:center;
        }
        .hero img{
          width:min(760px,92%);
          height:auto;
          filter:drop-shadow(0 14px 24px rgba(0,0,0,.15));
        }
        .header{
          display:flex;flex-direction:column;align-items:center;text-align:center;
          margin-bottom:20px;
        }
        .brand img{width:52px;height:52px;margin-bottom:8px;}
        .title{font-size:28px;font-weight:700;margin:0;letter-spacing:0.3px}
        .sub{color:var(--muted);margin-top:6px;font-size:15px;}
        .sub a{color:var(--purple);text-decoration:underline;font-weight:600}
        .grid{display:grid;gap:14px;margin-top:18px}
        label{display:block;font-weight:600;font-size:13px;color:var(--muted);margin-bottom:6px}
        .input{
          display:flex;align-items:center;gap:10px;
          background:#fff;border:1px solid var(--border);border-radius:12px;
          padding:12px 14px;
        }
        .input:focus-within{border-color:var(--purple);box-shadow:0 0 0 4px var(--ring)}
        .input input{border:0;outline:0;width:100%;background:transparent;font-size:15px;color:var(--black)}
        .toggle{border:0;background:transparent;color:var(--muted);font-weight:600;cursor:pointer}
        .hints{display:flex;flex-wrap:wrap;gap:16px;color:var(--muted);font-size:13px;margin-top:4px}
        .hints span::before{content:"• ";}
        .primary{
          margin-top:10px;width:100%;border:none;border-radius:999px;
          padding:14px 18px;background:var(--purple);color:var(--yellow);
          font-size:16px;font-weight:700;cursor:pointer;
          box-shadow:0 6px 16px rgba(88,35,159,.25);
          letter-spacing:0.4px;transition:all 0.2s ease-in-out;
        }
        .primary:hover{opacity:.9;transform:translateY(-1px);}
        .error{
          display:none;color:#b42318;background:#fee4e2;border:1px solid #fecdca;
          padding:10px 12px;border-radius:10px;margin-bottom:10px;
          font-size: 0.9em;
        }
    </style>
</head>
<body>
    <main class="page">
        <section class="panel">
            <div class="card">
                <div class="header">
                    <div class="brand">
                        {# Ensure the path to your logo is correct #}
                        <img src="{% static 'image/PadelinAja Logo.png' %}" alt="PadelinAja logo">
                    </div>
                    <h1 class="title">Welcome to the Community!</h1>
                    <div class="sub">Already have an account? <a href="{% url 'main:login' %}">Log in</a></div>
                </div>

                <form id="registerForm" class="grid" method="post" action="{% url 'main:register' %}">
                    {% csrf_token %} {# Django CSRF token #}
                    <div id="registerError" class="error" role="alert"></div>

                    <div>
                        <label for="id_username">Username</label>
                        <div class="input">
                            <input id="id_username" name="username" type="text" required autocomplete="username" placeholder="Enter username">
                        </div>
                    </div>

                    {# ADD EMAIL FIELD - Assuming your backend expects 'email' #}
                    <div>
                        <label for="id_email">Email</label>
                        <div class="input">
                            <input id="id_email" name="email" type="email" required autocomplete="email" placeholder="Enter your email">
                        </div>
                    </div>

                    <div>
                        <label for="id_password1">Password</label>
                        <div class="input">
                            {# Changed name to password to match simple view or use password1 if using Django Auth forms #}
                            <input id="id_password1" name="password" type="password" required autocomplete="new-password" placeholder="••••••••">
                            <button type="button" class="toggle" data-toggle="#id_password1">Show</button> {# Default text to Show #}
                        </div>
                        {# You might want password validation hints here if needed #}
                        </div>

                    {# REMOVED Password Confirmation - Simple view doesn't handle it #}
                    {# If your view DOES handle password confirmation (password1/password2), keep this block #}
                    <button type="submit" class="primary">Create an account</button>
                </form>
            </div>
        </section>

        <aside class="hero" aria-hidden="true">
             {# Ensure the path to your image is correct #}
            <img src="{% static 'image/register.png' %}" alt="Padel players illustration">
        </aside>
    </main>

    <script>
        function getCsrfToken() {
            const csrfCookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
            return csrfCookie ? csrfCookie.split('=')[1] : '';
        }

        const form = document.getElementById('registerForm');
        const errorBox = document.getElementById('registerError');

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorBox.style.display = 'none'; 
                errorBox.textContent = ''; 

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken() 
                        },
                        body: new FormData(form),
                        
                    });

                    if (!response.ok) {
                        
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (jsonError) {
                            throw new Error(response.statusText || 'Server error');
                        }
                        throw new Error(errorData.errors || response.statusText || 'Server error');
                    }

                    const data = await response.json();

                    if (data.success) {
                        window.location.href = data.redirect_url || "{% url 'main:show_main' %}";
                    } else {
                        errorBox.textContent = data.errors || 'Registration failed.';
                        errorBox.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Registration error:", error);
                    errorBox.textContent = error.message || 'An unexpected error occurred. Please try again.';
                    errorBox.style.display = 'block';
                }
            });
        }

        document.querySelectorAll('.toggle').forEach(btn => {
            const inputSelector = btn.getAttribute('data-toggle');
            if (inputSelector) {
                const input = document.querySelector(inputSelector);
                if (input) {
                    btn.addEventListener('click', () => {
                        const isPassword = input.type === 'password';
                        input.type = isPassword ? 'text' : 'password';
                        btn.textContent = isPassword ? 'Hide' : 'Show';
                    });
                } else {
                     console.warn(`Toggle button cannot find input: ${inputSelector}`);
                }
            }
        });
    </script>
</body>
</html>