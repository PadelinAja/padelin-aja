{% extends 'base.html' %}
{% load humanize %}
{% block content %}


<style>
  select.tailwind-search-input {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
  }
</style>

<svg width="0" height="0" style="display:none;">
    <symbol id="icon-search" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-map-pin" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></symbol>
    <symbol id="icon-dollar" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c2.11-.46 3.5-1.7 3.5-3.6 0-2.03-1.4-3.53-4.2-4.15z"/></symbol>
    <symbol id="icon-calendar" viewBox="0 0 24 24"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></symbol>
    <symbol id="icon-user" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
</svg>

<main class="max-w-6xl mx-auto py-6 px-4" role="main">

  <div class="my-6">
    <h1 class="text-4xl font-bold text-black m-0">FIND YOUR NEXT <span class="text-purple-700">MATCH</span></h1>
  </div>

  <form class="flex flex-col md:flex-row items-stretch md:items-center gap-4 mb-8" action="{% url 'main:event_page' %}" method="GET">
    
    <div class="relative flex items-center flex-1 min-w-[180px]">
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 fill-gray-500 pointer-events-none"><use href="#icon-search"></use></svg>
      <input type="text" name="q" class="w-full p-3 pl-12 text-base border-2 border-purple-700 rounded-lg box-border placeholder-gray-400" placeholder="Search Event Name/Desc" value="{{ search_query|default:'' }}">
    </div>

    <div class="relative flex items-center flex-1 min-w-[180px]">
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 fill-gray-500 pointer-events-none"><use href="#icon-map-pin"></use></svg>
      <select name="city" class="w-full p-3 pl-12 text-base border-2 border-purple-700 rounded-lg box-border bg-white tailwind-search-input">
        <option value="">Choose City</option>
        <option value="jakarta" {% if city_filter == 'jakarta' %}selected{% endif %}>Jakarta</option>
        <option value="bogor" {% if city_filter == 'bogor' %}selected{% endif %}>Bogor</option>
        <option value="bandung" {% if city_filter == 'bandung' %}selected{% endif %}>Bandung</option>
      </select>
    </div>

    <div class="relative flex items-center flex-1 min-w-[180px]">
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 fill-gray-500 pointer-events-none"><use href="#icon-dollar"></use></svg>
      <select name="price" class="w-full p-3 pl-12 text-base border-2 border-purple-700 rounded-lg box-border bg-white tailwind-search-input">
        <option value="">Choose Price Range</option>
        <option value="<100k" {% if price_filter == '<100k' %}selected{% endif %}>&lt; Rp 100.000</option>
        <option value="100k-200k" {% if price_filter == '100k-200k' %}selected{% endif %}>Rp 100.000 - Rp 200.000</option>
        <option value=">200k" {% if price_filter == '>200k' %}selected{% endif %}>&gt; Rp 200.000</option>
      </select>
    </div>

    <button type="submit" class="py-3 px-6 text-base font-bold text-white bg-purple-700 rounded-lg cursor-pointer transition hover:bg-purple-800 hover:-translate-y-0.5">Search</button> 
    {% if user.is_authenticated %}
      <a href="#" id="publishBtn" class="py-3 px-6 text-base font-bold text-black bg-yellow-300 rounded-lg cursor-pointer transition text-center hover:bg-yellow-400 hover:-translate-y-0.5">+ Add Events</a> 
    {% endif %}
  </form>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="eventGrid">
    {% for event in events %}
      <div class="bg-white rounded-xl shadow-md border border-gray-100 transition hover:-translate-y-1 hover:shadow-lg">
        <div class="flex items-start gap-5 p-6 cursor-pointer" data-id="{{ event.id }}">
          <div class="shrink-0">
            <img class="w-20 h-20 rounded-full object-cover border-2 border-gray-100" src="{{ event.image_url|default:'https://placehold.co/80x80/FEF9F9/6A1B9A?text=RQ' }}" alt="{{ event.name }} logo">
          </div>
          <div class="flex-1">
            <h2 class="text-2xl font-semibold text-black mb-1">{{ event.name }}</h2>
            <p class="text-base text-gray-500 mb-4">{{ event.type }}</p>
            <ul class="list-none p-0 m-0 space-y-2">
              <li class="flex items-center text-gray-800 text-sm"><svg class="w-4 h-4 mr-3 fill-gray-600 shrink-0"><use href="#icon-calendar"></use></svg> {{ event.date|date:"d F Y, H:i" }} WIB</li>
              <li class="flex items-center text-gray-800 text-sm"><svg class="w-4 h-4 mr-3 fill-gray-600 shrink-0"><use href="#icon-map-pin"></use></svg> {{ event.venue.name }}</li>
              <li class="flex items-center text-gray-800 text-sm"><svg class="w-4 h-4 mr-3 fill-gray-600 shrink-0"><use href="#icon-dollar"></use></svg> Rp {{ event.price|intcomma }}</li>
            </ul>
          </div>
        </div>

        {% if user.is_authenticated and event.user == user %}
          <div class="flex justify-end gap-2 px-5 pb-5 pt-4 border-t border-gray-100 mt-2">
            <button class="bg-transparent text-gray-600 border border-transparent rounded px-4 py-2 font-semibold text-sm cursor-pointer transition hover:bg-gray-100" data-id="{{ event.id }}">Edit</button>
            <button class="bg-transparent text-red-600 border border-transparent rounded px-4 py-2 font-semibold text-sm cursor-pointer transition hover:bg-red-100" data-id="{{ event.id }}">Delete</button>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>There are no events available. Please check back later!</p>
    {% endfor %}
  </div>
</main>

<div id="detailModal" class="hidden fixed inset-0 w-screen h-screen bg-black/40 z-[1001] overflow-y-auto items-center justify-center p-5"> 
    <div class="bg-white max-w-3xl w-full m-0 p-6 rounded-lg shadow-lg relative">
      <button id="closeDetailModal" class="absolute top-3 right-4 text-2xl bg-none border-none cursor-pointer font-bold text-gray-500 transition hover:text-black">&times;</button>
      <div id="detailContentContainer"> 
        </div>
    </div>
</div>
  
<div id="addEventModal" class="hidden fixed inset-0 w-screen h-screen bg-black/40 z-[1001] overflow-y-auto items-center justify-center p-5"> 
    <div class="bg-white max-w-3xl w-full m-0 p-6 rounded-lg shadow-lg relative">
      <button id="closeAddEventModal" class="absolute top-3 right-4 text-2xl bg-none border-none cursor-pointer font-bold text-gray-500 transition hover:text-black">&times;</button>
      <h2 class="text-2xl font-bold mb-4">Add New Event</h2>
      <div id="addEventFormContainer">
      </div>
      <div id="addEventFormMsg" class="mt-3 font-semibold"></div> 
    </div>
</div>
  
<div id="editEventModal" class="hidden fixed inset-0 w-screen h-screen bg-black/40 z-[1001] overflow-y-auto items-center justify-center p-5"> 
    <div class="bg-white max-w-3xl w-full m-0 p-6 rounded-lg shadow-lg relative">
      <button id="closeEditEventModal" class="absolute top-3 right-4 text-2xl bg-none border-none cursor-pointer font-bold text-gray-500 transition hover:text-black">&times;</button>
      <h2 class="text-2xl font-bold mb-4">Edit Event</h2>
      <div id="editEventFormContainer">
      </div>
      <div id="editEventFormMsg" class="mt-3 font-semibold"></div> 
    </div>
</div>
  
<footer class="text-center text-gray-500 py-6 text-sm border-t border-gray-200 mt-10">
    <small>Copyright @PadelinAja. All Rights Reserved.</small>
</footer>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        const detailModal = document.getElementById('detailModal');
        const closeDetailModal = document.getElementById('closeDetailModal');
        const detailContentContainer = document.getElementById('detailContentContainer');
        const addEventModal = document.getElementById('addEventModal');
        const addEventBtn = document.getElementById('publishBtn'); 
        const closeAddEventModal = document.getElementById('closeAddEventModal');
        const addEventFormContainer = document.getElementById('addEventFormContainer');
        const addEventFormMsg = document.getElementById('addEventFormMsg');
        const editEventModal = document.getElementById('editEventModal');
        const closeEditEventModal = document.getElementById('closeEditEventModal');
        const editEventFormContainer = document.getElementById('editEventFormContainer');
        const editEventFormMsg = document.getElementById('editEventFormMsg');
        const eventGrid = document.getElementById('eventGrid');
    
        function openModal(modalElement) {
            if(modalElement) {
                modalElement.classList.remove('hidden');
                modalElement.classList.add('flex');
            }
        }
        function closeModal(modalElement) {
            if(modalElement) {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('flex');
            }
        }
    
        if (addEventBtn) {
            addEventBtn.onclick = function(e) {
                e.preventDefault();
                addEventFormContainer.innerHTML = '<p>Loading form...</p>';
                addEventFormMsg.textContent = '';
                openModal(addEventModal); 
                fetch(`/ajax_event_form/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                    .then(r => r.json())
                    .then(data => { 
                        if(data.html) {
                            addEventFormContainer.innerHTML = data.html; 
                            attachFormHandler(addEventFormContainer, addEventFormMsg, addEventModal); 
                            applyTailwindToForm(addEventFormContainer);
                        } else { addEventFormContainer.innerHTML = '<p>Error: Could not load form.</p>'; }
                    })
                    .catch(error => { console.error('Error fetching event form:', error); });
            }
        } else {
            console.warn("Add Event button ('#publishBtn') not found."); 
        }
    
        if (eventGrid) {
            eventGrid.addEventListener('click', function(e) {
                const clickableCard = e.target.closest('div[data-id]');
                const editButton = e.target.closest('button[data-id].bg-transparent');
                const deleteButton = e.target.closest('button[data-id].text-red-600');
    
                if (deleteButton) {
                    e.preventDefault();
                    e.stopPropagation();
                    const eventId = deleteButton.dataset.id;
                    if (confirm('Are you sure you want to delete this event?')) {
                        const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                        fetch(`/ajax_delete/event/${eventId}/`, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) { location.reload(); } 
                            else { alert('Error deleting event: ' + data.errors); }
                        })
                        .catch(error => { console.error('Error deleting event:', error); });
                    }
                    return; 
                }
    
                if (editButton) {
                    e.preventDefault();
                    e.stopPropagation();
                    const eventId = editButton.dataset.id;
                    editEventFormContainer.innerHTML = '<p>Loading edit form...</p>';
                    editEventFormMsg.textContent = '';
                    openModal(editEventModal); 
    
                    fetch(`/ajax_edit/event/${eventId}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                    .then(response => response.json())
                    .then(data => {
                        if (data.html) {
                            editEventFormContainer.innerHTML = data.html;
                            attachFormHandler(editEventFormContainer, editEventFormMsg, editEventModal);
                            applyTailwindToForm(editEventFormContainer);
                        } else { editEventFormContainer.innerHTML = '<p>Sorry, edit form could not be loaded.</p>'; }
                    })
                    .catch(error => { console.error('Error fetching edit form:', error); });
                    return; 
                }
    
                if (clickableCard) {
                    const eventId = clickableCard.dataset.id;
                    detailContentContainer.innerHTML = '<p>Loading details...</p>';
                    openModal(detailModal); 
    
                    fetch(`/ajax_event_detail/${eventId}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                    .then(response => response.json())
                    .then(data => {
                        if (data.html) { 
                            detailContentContainer.innerHTML = data.html; 
                            applyTailwindToDetail(detailContentContainer);
                        } 
                        else { detailContentContainer.innerHTML = '<p>Sorry, details could not be loaded.</p>'; }
                    })
                    .catch(error => { console.error('Error fetching event details:', error); });
                }
            });
        } else {
             console.warn("Event grid ('#eventGrid') not found.");
        }
    
        function attachFormHandler(formContainer, msgContainer, modalInstance) {
            const form = formContainer.querySelector('form'); 
            if (!form) return;

            const submitButton = form.querySelector('button[type="submit"]');
            if(submitButton) {
                submitButton.classList.add('w-full', 'mt-4', 'bg-purple-700', 'text-white', 'p-3', 'border-none', 'rounded-lg', 'cursor-pointer', 'font-bold', 'transition', 'hover:bg-purple-800', 'hover:-translate-y-0.5');
            }

            form.onsubmit = function(e) {
                e.preventDefault();
                msgContainer.textContent = '';
                const data = new FormData(form);
                const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                fetch(form.action, { 
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                    body: data
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        msgContainer.style.color = '#080';
                        msgContainer.textContent = 'Success!';
                        setTimeout(() => { location.reload(); }, 1200);
                    } else {
                        msgContainer.style.color = '#b00';
                        msgContainer.textContent = 'Please correct the errors in the form.';
                        if (res.errors && typeof res.errors === 'string') {
                             try { 
                                const errors = JSON.parse(res.errors); 
                                form.querySelectorAll('.form-error').forEach(el => el.remove());
                                for (const fieldName in errors) {
                                    const field = form.querySelector(`[name="${fieldName}"]`);
                                    const errorList = errors[fieldName];
                                    if (field && errorList.length > 0) {
                                        const errorEl = document.createElement('div');
                                        errorEl.className = 'form-error';
                                        errorEl.classList.add('text-red-700', 'text-sm', 'mt-1');
                                        errorEl.textContent = errorList.map(e => e.message).join(' ');
                                        field.parentNode.insertBefore(errorEl, field.nextSibling);
                                    }
                                }
                            } catch (e) { 
                                 msgContainer.textContent = res.errors; 
                                 console.error('Could not parse form errors JSON:', e); 
                            }
                        } else if (typeof res.errors === 'string') { 
                             msgContainer.textContent = res.errors;
                        }
                    }
                })
                .catch(error => { console.error('Error submitting form:', error); });
            };
        }

        function applyTailwindToForm(formContainer) {
            formContainer.querySelectorAll('.form-group').forEach(group => {
                group.classList.add('mb-4');
            });
            formContainer.querySelectorAll('label').forEach(label => {
                label.classList.add('block', 'font-semibold', 'text-sm', 'mb-1', 'text-gray-700');
            });
            formContainer.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(input => {
                input.classList.add('w-full', 'p-2.5', 'border', 'border-gray-300', 'rounded-md', 'box-border', 'text-base', 'focus:border-purple-500', 'focus:ring', 'focus:ring-purple-200', 'focus:outline-none');
                if(input.tagName === 'SELECT') {
                    input.classList.add('appearance-none', 'bg-white', 'tailwind-search-input');
                }
            });
        }

        function applyTailwindToDetail(detailContainer) {
            detailContainer.querySelectorAll('.detail-container-flex').forEach(el => {
                el.classList.add('flex', 'flex-col', 'md:flex-row', 'items-center', 'gap-5');
            });
            detailContainer.querySelectorAll('.detail-left-col').forEach(el => {
                el.classList.add('flex-1', 'text-center');
            });
            detailContainer.querySelectorAll('.detail-left-col img').forEach(el => {
                el.classList.add('w-40', 'h-40', 'rounded-full', 'border-4', 'border-gray-100', 'mb-5', 'mx-auto');
            });
            detailContainer.querySelectorAll('.detail-left-col h2').forEach(el => {
                el.classList.add('text-4xl', 'font-bold', 'text-black', 'mb-2', 'leading-tight');
            });
            detailContainer.querySelectorAll('.detail-left-col .detail-category').forEach(el => {
                el.classList.add('text-base', 'text-gray-500');
            });
            detailContainer.querySelectorAll('.detail-divider').forEach(el => {
                el.classList.add('w-full', 'md:w-px', 'md:self-stretch', 'bg-gray-200', 'h-px', 'md:h-auto', 'my-4', 'md:my-0', 'md:mx-2');
            });
            detailContainer.querySelectorAll('.detail-right-col').forEach(el => {
                el.classList.add('flex-1.5', 'w-full', 'flex', 'flex-col', 'gap-7');
            });
            detailContainer.querySelectorAll('.detail-header-right').forEach(el => {
                el.classList.add('flex', 'flex-col', 'sm:flex-row', 'justify-between', 'items-center', 'gap-4');
            });
            detailContainer.querySelectorAll('.detail-price').forEach(el => {
                el.classList.add('text-3xl', 'font-bold', 'text-purple-700', 'whitespace-nowrap');
            });
            detailContainer.querySelectorAll('.btn-contact').forEach(el => {
                el.classList.add('bg-yellow-300', 'text-black', 'py-3', 'px-7', 'rounded-full', 'font-semibold', 'text-base', 'cursor-pointer', 'no-underline', 'transition', 'whitespace-nowrap', 'shrink-0', 'hover:bg-yellow-400', 'hover:-translate-y-0.5');
            });
            detailContainer.querySelectorAll('.detail-info-group').forEach(el => {
                el.classList.add('flex', 'items-start', 'gap-4');
            });
            detailContainer.querySelectorAll('.detail-info-group .icon').forEach(el => {
                el.classList.add('w-6', 'h-6', 'fill-gray-800', 'mt-1', 'shrink-0');
            });
            detailContainer.querySelectorAll('.detail-info-group .info-content').forEach(el => {
                el.classList.add('flex', 'flex-col');
            });
            detailContainer.querySelectorAll('.detail-info-group .info-content strong').forEach(el => {
                el.classList.add('text-lg', 'font-bold', 'text-black', 'mb-1');
            });
            detailContainer.querySelectorAll('.detail-info-group .info-content span').forEach(el => {
                el.classList.add('text-base', 'text-gray-600', 'leading-normal');
            });

            detailContainer.querySelectorAll('script').forEach(el => el.remove());
        }
    
        if(closeDetailModal) closeDetailModal.onclick = () => { closeModal(detailModal); }
        if(closeAddEventModal) closeAddEventModal.onclick = () => { closeModal(addEventModal); }
        if(closeEditEventModal) closeEditEventModal.onclick = () => { closeModal(editEventModal); }
    
        window.onclick = e => {
            if (e.target == detailModal) closeModal(detailModal);
            if (e.target == addEventModal) closeModal(addEventModal);
            if (e.target == editEventModal) closeModal(editEventModal);
        };
    
    });
    </script>

{% endblock content %}