{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

{% include 'navbar.html' %}

<style>
  /* ... (CSS Dasar, Container, Footer kamu tetap sama) ... */
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; padding: 0; background: #FEF9F9; color: #333; }
  .container { max-width: 900px; margin: 24px auto; padding: 16px; }
  footer { text-align: center; color: #666; padding: 24px 0; font-size: 0.9rem; border-top: 1px solid #eee; margin-top: 40px; }

  /* Blog Detail Styles (Sama) */
  .blog-detail img.banner-image { width: 100%; height: 400px; object-fit: cover; border-radius: 8px; margin-bottom: 32px; }
  .blog-detail h1.title { font-size: 2.8rem; font-weight: 700; color: #000000; margin: 0 0 24px 0; line-height: 1.2; }
  .blog-detail .content { font-size: 1.1rem; color: #444; line-height: 1.7; }
  .blog-detail .content p { margin-bottom: 1.5em; }
  .blog-detail .author-info { font-size: 0.95rem; color: #666; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; }
  
  /* BARU: Style Tombol Edit/Delete di Bawah */
  .detail-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 30px; 
    padding-top: 20px;
    border-top: 1px solid #eee;
  }
  .btn-edit-detail, .btn-delete-detail {
    border: none;
    border-radius: 20px;
    padding: 10px 20px; /* Sedikit lebih besar */
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease;
  }
  .btn-edit-detail { background-color: #FFED2C; color: #000; }
  .btn-edit-detail:hover { background-color: #f0de20; transform: translateY(-1px); }
  .btn-delete-detail { background-color: #dc3545; color: white; }
  .btn-delete-detail:hover { background-color: #c82333; transform: translateY(-1px); }

  /* Modal Styles (Sama) */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); z-index: 1001; overflow-y: auto; align-items: center; justify-content: center; padding: 20px; }
  .modal.is-active { display: flex; }
  .modal .modal-content { background: #fff; max-width: 600px; width: 100%; margin: 0; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #0002; position: relative; }
  .modal .modal-close { position:absolute; top:12px; right:16px; font-size:1.5em; background:none; border:none; cursor:pointer; font-weight: bold; color: #888; transition: color 0.2s ease; }
  .modal .modal-close:hover { color: #000; }
  #editBlogFormMsg { margin-top: 12px; font-weight: 600; }
  .btn-submit-form { width: 100%; margin-top: 16px; background-color: #6A1B9A; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease, transform 0.2s ease;}
  .btn-submit-form:hover { background-color: #5a1683; transform: translateY(-2px); }
</style>

<main class="container blog-detail" role="main">

  {% if article %}
    <img src="{{ article.image_url|default:'https://placehold.co/1200x400/eee/ccc?text=Blog+Banner' }}" 
         alt="{{ article.title }}" class="banner-image">

    <h1 class="title">{{ article.title }}</h1>

    <p style="font-size: 1.1em; color: #555; margin-top: -15px; margin-bottom: 25px; font-weight: 600;">
      {{ article.category }}
    </p>

    <div class="content">
      {{ article.content|linebreaks }}
    </div>

    {% if article.user %}
      <p class="author-info">
        Author: {{ article.user.username }} <br> Published on {{ article.published_date|date:"F j, Y H:i" }} WIB
      </p>
    {% else %}
       <p class="author-info">
         Author: Author Name <br> Published on {{ article.published_date|date:"F j, Y H:i" }} WIB
       </p>
    {% endif %}

    {% if user.is_authenticated and article.user == user %}
      <div class="detail-actions">
        <button id="editBtnDetail" class="btn-edit-detail" data-id="{{ article.id }}">Edit</button>
        <button id="deleteBtnDetail" class="btn-delete-detail" data-id="{{ article.id }}">Delete</button>
      </div>
    {% endif %}
    
  {% else %}
    <p>Article not found.</p>
  {% endif %}

</main>

<div id="editBlogModal" class="modal">
  <div class="modal-content">
    <button id="closeEditBlogModal" class="modal-close">&times;</button>
    <h2>Edit Blog Post</h2>
    <div id="editBlogFormContainer"></div>
    <div id="editBlogFormMsg"></div>
  </div>
</div>

<footer>
  <small>Copyright @PadelinAja. All Rights Reserved.</small>
</footer>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // --- Variabel Modal Edit ---
    const editBlogModal = document.getElementById('editBlogModal');
    const closeEditBlogModal = document.getElementById('closeEditBlogModal');
    const editBlogFormContainer = document.getElementById('editBlogFormContainer');
    const editBlogFormMsg = document.getElementById('editBlogFormMsg');

    // --- Tombol di Halaman Detail ---
    const editBtnDetail = document.getElementById('editBtnDetail');
    const deleteBtnDetail = document.getElementById('deleteBtnDetail');

    // === Fungsi Buka/Tutup Modal ===
    function openModal(modalElement) { modalElement.classList.add('is-active'); }
    function closeModal(modalElement) { modalElement.classList.remove('is-active'); }

    // --- Penanganan Tombol EDIT ---
    if (editBtnDetail) {
        editBtnDetail.onclick = function(e) {
            const articleId = this.dataset.id;
            editBlogFormContainer.innerHTML = '<p>Loading edit form...</p>';
            editBlogFormMsg.textContent = '';
            openModal(editBlogModal); 

            fetch(`/ajax_edit/article/${articleId}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    editBlogFormContainer.innerHTML = data.html;
                    attachFormHandler(editBlogFormContainer, editBlogFormMsg, editBlogModal);
                } else { editBlogFormContainer.innerHTML = '<p>Sorry, edit form could not be loaded.</p>'; }
            })
            .catch(error => { console.error('Error fetching edit form:', error); });
        }
    }

    // --- Penanganan Tombol DELETE ---
    if (deleteBtnDetail) {
        deleteBtnDetail.onclick = function(e) {
            const articleId = this.dataset.id;
            if (confirm('Are you sure you want to delete this blog post?')) {
                const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                fetch(`/ajax_delete/article/${articleId}/`, { 
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) { 
                        // Redirect ke halaman daftar blog setelah delete
                        window.location.href = "{% url 'main:article_list' %}"; 
                    } 
                    else { alert('Error deleting post: ' + data.errors); }
                })
                .catch(error => { console.error('Error deleting post:', error); });
            }
        }
    }

    // --- Fungsi Handler Form (Sama) ---
    function attachFormHandler(formContainer, msgContainer, modalInstance) {
        // ... (Kode fungsi attachFormHandler kamu tetap sama) ...
        const form = formContainer.querySelector('form'); 
        if (!form) return;
        form.onsubmit = function(e) {
            e.preventDefault();
            msgContainer.textContent = '';
            const data = new FormData(form);
            const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            fetch(form.action, { 
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                body: data
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    msgContainer.style.color = '#080';
                    msgContainer.textContent = 'Success!';
                    setTimeout(() => { location.reload(); }, 1200); // Reload halaman detail
                } else {
                    msgContainer.style.color = '#b00';
                    msgContainer.textContent = 'Please correct the errors in the form.';
                    if (typeof res.errors === 'object' && res.errors !== null) {
                         try {
                            const errors = JSON.parse(res.errors); 
                            form.querySelectorAll('.form-error').forEach(el => el.remove());
                            for (const fieldName in errors) {
                                const field = form.querySelector(`[name="${fieldName}"]`);
                                const errorList = errors[fieldName];
                                if (field && errorList.length > 0) {
                                    const errorEl = document.createElement('div');
                                    errorEl.className = 'form-error';
                                    errorEl.style.color = '#b00';
                                    errorEl.style.fontSize = '0.85rem';
                                    errorEl.style.marginTop = '4px';
                                    errorEl.textContent = errorList.map(e => e.message).join(' ');
                                    field.parentNode.insertBefore(errorEl, field.nextSibling);
                                }
                            }
                        } catch (e) { console.error('Could not parse form errors:', e); }
                    } else if (typeof res.errors === 'string') {
                         msgContainer.textContent = res.errors; 
                    }
                }
            })
            .catch(error => { console.error('Error submitting form:', error); });
        };
    }

    // --- Fungsi Penutup Modal ---
    if (closeEditBlogModal) closeEditBlogModal.onclick = () => { closeModal(editBlogModal); }
    window.onclick = e => {
        if (e.target == editBlogModal) closeModal(editBlogModal);
    };

});
</script>

{% endblock content %}