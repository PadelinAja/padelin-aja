{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
<title>{{ article.title }} - Padel In Aja</title>
{% endblock meta %}

{% block content %}

<style>
  select.tailwind-search-input {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
  }
</style>

<main class="max-w-4xl mx-auto py-10 px-6 sm:px-10 bg-white shadow-xl rounded-lg my-10" role="main">

  {% if article %}
    {% if article.image_url %}
    <img src="{{ article.image_url }}" alt="{{ article.title }}" class="w-full h-96 object-cover rounded-lg mb-8">
    {% endif %}

    <h1 class="text-4xl md:text-5xl font-bold text-black mb-2 leading-tight">{{ article.title }}</h1>

    <p class="text-lg text-gray-500 font-semibold mb-6 block">
      {{ article.category }}
    </p>

    <div class="prose prose-lg max-w-none text-gray-800 leading-relaxed">
      {{ article.content|linebreaks }}
    </div>

    <p class="text-base text-gray-500 mt-10 pt-6 border-t border-gray-200 leading-relaxed">
      {% if article.user %}
        Author: {{ article.user.username }} <br>
      {% else %}
         Author: Unknown <br>
      {% endif %}
      Published on {{ article.published_date|date:"F j, Y H:i" }} WIB
    </p>

    {% if user.is_authenticated and article.user == user %}
      <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-200">
            {# ADDED ID ATTRIBUTES HERE #}
            <button class="bg-transparent text-gray-600 border border-transparent rounded px-4 py-2 font-semibold text-sm cursor-pointer transition hover:bg-gray-100" 
                    data-id="{{ article.id }}" **id="editBtnDetail"**>Edit</button>
            <button class="bg-transparent text-red-600 border border-transparent rounded px-4 py-2 font-semibold text-sm cursor-pointer transition hover:bg-red-100" 
                    data-id="{{ article.id }}" **id="deleteBtnDetail"**>Delete</button>
      </div>
    {% endif %}

  {% else %}
    <p>Article not found.</p>
  {% endif %}

</main>

<div id="editBlogModal" class="hidden fixed inset-0 w-screen h-screen bg-black/40 z-[1001] overflow-y-auto items-center justify-center p-5">
  <div class="bg-white max-w-2xl w-full m-0 p-6 rounded-lg shadow-lg relative">
    <button id="closeEditBlogModal" class="absolute top-3 right-4 text-2xl bg-none border-none cursor-pointer font-bold text-gray-500 transition hover:text-black">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Edit Blog Post</h2>
    <div id="editBlogFormContainer"></div>
    <div id="editBlogFormMsg" class="mt-3 font-semibold"></div>
  </div>
</div>

<footer class="text-center text-gray-500 py-6 text-sm border-t border-gray-200 mt-10">
  <small>Copyright @PadelinAja. All Rights Reserved.</small>
</footer>

{% endblock content %}

{% block scripts %}
<script>

    // --- Shared Helper Functions ---

    function openModal(modalElement) {
        if(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex');
        }
    }
    function closeModal(modalElement) {
        if(modalElement) {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('flex');
        }
    }

    function applyTailwindToForm(formContainer) {
        formContainer.querySelectorAll('.form-group').forEach(group => {
            group.classList.add('mb-4');
        });
        formContainer.querySelectorAll('label').forEach(label => {
            label.classList.add('block', 'font-semibold', 'text-sm', 'mb-1', 'text-gray-700');
        });
        formContainer.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(input => {
            input.classList.add('w-full', 'p-2.5', 'border', 'border-gray-300', 'rounded-md', 'box-border', 'text-base', 'focus:border-purple-500', 'focus:ring', 'focus:ring-purple-200', 'focus:outline-none');
            if(input.tagName === 'SELECT') {
                input.classList.add('appearance-none', 'bg-white', 'tailwind-search-input');
            }
            if(input.tagName === 'TEXTAREA') {
                input.setAttribute('rows', '6');
            }
        });
         formContainer.querySelectorAll('button[type="submit"]').forEach(button => {
            button.classList.add('w-full', 'mt-4', 'bg-purple-700', 'text-white', 'p-3', 'border-none', 'rounded-lg', 'cursor-pointer', 'font-bold', 'transition', 'hover:bg-purple-800', 'hover:-translate-y-0.5');
        });
    }

    function attachFormHandler(formContainer, msgContainer, modalInstance) {
        const form = formContainer.querySelector('form');
        if (!form) return;

        form.onsubmit = function(e) {
            e.preventDefault();
            msgContainer.textContent = '';
            const data = new FormData(form);
            const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

            fetch(form.action, { 
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                body: data
            })
            .then(response => response.json())
            .then(res => {
                if (res.success) {
                    msgContainer.style.color = '#080';
                    msgContainer.textContent = 'Success!';
                    // Use location.reload() for simplicity to show updated content
                    setTimeout(() => { location.reload(); }, 1200); 
                } else {
                    msgContainer.style.color = '#b00';
                    msgContainer.textContent = 'Please correct the errors in the form.';
                    
                    if (res.errors && typeof res.errors === 'string') {
                         try {
                             const errors = JSON.parse(res.errors);
                             form.querySelectorAll('.form-error').forEach(el => el.remove()); 
                             for (const fieldName in errors) {
                                 const field = form.querySelector(`[name="${fieldName}"]`);
                                 const errorList = errors[fieldName];
                                 if (field && errorList.length > 0) {
                                     const errorEl = document.createElement('div');
                                     errorEl.className = 'form-error';
                                     errorEl.classList.add('text-red-700', 'text-sm', 'mt-1');
                                     errorEl.textContent = errorList.map(e => e.message).join(' ');
                                     field.parentNode.insertBefore(errorEl, field.nextSibling);
                                 }
                             }
                         } catch (e) {
                             msgContainer.textContent = res.errors; 
                             console.error('Could not parse form errors JSON:', e);
                         }
                    } else if (typeof res.errors === 'string') {
                        msgContainer.textContent = res.errors; 
                    }
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                msgContainer.style.color = '#b00';
                msgContainer.textContent = 'An unexpected error occurred.';
            });
        };
    }

    // --- Detail Page Logic ---
    
    // Use the standard and reliable way to ensure the DOM is ready
    document.addEventListener("DOMContentLoaded", function() {

        const editBlogModal = document.getElementById('editBlogModal');
        const closeEditBlogModal = document.getElementById('closeEditBlogModal');
        const editBlogFormContainer = document.getElementById('editBlogFormContainer');
        const editBlogFormMsg = document.getElementById('editBlogFormMsg');

        // Target the buttons with the new IDs
        const editBtnDetail = document.getElementById('editBtnDetail');
        const deleteBtnDetail = document.getElementById('deleteBtnDetail');
        
        // --- Edit Button Handler ---
        if (editBtnDetail) {
            editBtnDetail.onclick = function(e) {
                console.log('Edit button clicked for article ID:', this.dataset.id);
                
                const articleId = this.dataset.id;
                editBlogFormContainer.innerHTML = '<p>Loading edit form...</p>';
                editBlogFormMsg.textContent = '';
                openModal(editBlogModal);

                // URL should be: /ajax_edit/article/{{article.id}}/
                fetch(`/ajax_edit/article/${articleId}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.html) {
                        // The container is the element to pass, not the form itself
                        editBlogFormContainer.innerHTML = data.html; 
                        attachFormHandler(editBlogFormContainer, editBlogFormMsg, editBlogModal);
                        applyTailwindToForm(editBlogFormContainer);
                    } else {
                        editBlogFormContainer.innerHTML = '<p>Sorry, edit form could not be loaded.</p>';
                        console.error("Error loading edit form HTML:", data.error || 'No HTML received');
                    }
                })
                .catch(error => {
                    console.error('Error fetching edit form:', error);
                    editBlogFormContainer.innerHTML = `<p>Error loading edit form. Please check console. Error: ${error.message}</p>`;
                });
            }
        }

        // --- Delete Button Handler ---
        if (deleteBtnDetail) {
            deleteBtnDetail.onclick = function(e) {
                console.log('Delete button clicked for article ID:', this.dataset.id);

                const articleId = this.dataset.id;
                if (confirm('Are you sure you want to delete this blog post?')) {
                    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                    fetch(`/ajax_delete/article/${articleId}/`, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alert('Blog post deleted successfully!');
                            // Redirect to the article list page after successful deletion
                            // NOTE: Ensure 'main:article_list' is a valid, existing URL name in your Django urls.py
                            window.location.href = "{% url 'main:article_list' %}"; 
                        } else {
                            alert('Error deleting post: ' + (data.errors || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting post:', error);
                        alert('An error occurred while deleting. Please try again. Error: ' + error.message);
                    });
                }
            }
        }

        // Close modal handlers
        if (closeEditBlogModal) closeEditBlogModal.onclick = () => { closeModal(editBlogModal); }
        window.onclick = e => {
            if (e.target == editBlogModal) closeModal(editBlogModal);
        };

    });
</script>

{% endblock scripts %}
