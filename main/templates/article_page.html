{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<style>
  select.tailwind-select-arrow {
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
    padding-right: 2.5rem;
  }
</style>

<svg width="0" height="0" style="display:none;">
    <symbol id="icon-search" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-tag" viewBox="0 0 24 24"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41s-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></symbol>
</svg>

<main class="max-w-6xl mx-auto py-6 px-4" role="main">

  <div class="my-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
    <h1 class="text-4xl font-bold text-black m-0">BLOGS <span class="text-purple-700">AND </span>UPDATES</h1>
  </div>

  <form class="flex flex-col md:flex-row flex-wrap gap-4 items-center mb-8" action="{% url 'main:article_list' %}" method="GET">
    
    <div class="relative w-full md:flex-1">
      <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><use href="#icon-search"></use></svg>
      <input type="text" name="q" 
             class="w-full py-3 px-4 pl-10 text-base border-2 border-purple-700 rounded-lg box-border placeholder-gray-400 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500" 
             placeholder="Search Title/Content" value="{{ search_query|default:'' }}">
    </div>

    <div class="relative w-full md:flex-1">
      <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><use href="#icon-tag"></use></svg>
      <select name="category" 
              class="w-full py-3 px-4 pl-10 text-base border-2 border-purple-700 rounded-lg box-border bg-white tailwind-select-arrow focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
        <option value="">Choose Category</option>
        <option value="Beginner Guides" {% if category_filter == 'Beginner Guides' %}selected{% endif %}>
          Beginner Guides
        </option>
        <option value="Technique & Strategy" {% if category_filter == 'Technique & Strategy' %}selected{% endif %}>
          Technique & Strategy
        </option>
        <option value="Fitness & Warm-Ups" {% if category_filter == 'Fitness & Warm-Ups' %}selected{% endif %}>
          Fitness & Warm-Ups
        </option>
        <option value="Coaching Insights" {% if category_filter == 'Coaching Insights' %}selected{% endif %}>
          Coaching Insights
        </option>
      </select>
    </div>

    <button type="submit" 
            class="w-full md:w-auto py-3 px-8 text-base font-bold text-white bg-[#6A1B9A] rounded-lg cursor-pointer transition hover:bg-purple-800 hover:-translate-y-0.5">
            Search
    </button>

    {% if user.is_authenticated %}
      <a href="#" id="addBlogBtn" 
         class="w-full md:w-auto py-3 px-6 text-base font-bold text-black bg-[#FFED2C] rounded-lg cursor-pointer transition no-underline hover:bg-yellow-500 hover:-translate-y-0.5 whitespace-nowrap text-center">
         + Add Blog
      </a>
    {% endif %}
  </form>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="blogGrid">
    {% for article in articles %}
      <div class="bg-white rounded-lg overflow-hidden shadow-md border border-gray-100 transition hover:-translate-y-1 hover:shadow-lg flex flex-col">
        <article class="flex flex-col flex-grow">
          <a href="{% url 'main:show_article' article.id %}"> 
            <img class="w-full h-52 object-cover" src="{{ article.image_url|default:'https://placehold.co/600x400/eee/ccc?text=Blog+Image' }}" alt="{{ article.title }}">
          </a>
          <div class="p-5 flex-grow flex flex-col">
            <h2 class="text-xl font-semibold text-black mb-2">{{ article.title }}</h2>
            <p class="text-sm text-gray-500 font-medium -mt-1 mb-3">
              {{ article.category }}
            </p>
            <p class="text-base text-gray-600 leading-relaxed line-clamp-3 mb-4 flex-grow">{{ article.content|truncatewords:30 }}</p>
            <a href="{% url 'main:show_article' article.id %}" class="text-sm font-semibold text-purple-700 no-underline transition hover:text-purple-900 mt-2">Read More â†’</a>
          </div>
        </article>
        
        {% if user.is_authenticated and article.user == user %}
          <div class="flex justify-end gap-2 px-5 py-4 border-t border-gray-100 mt-auto">
            <button class="bg-transparent text-gray-600 border border-transparent rounded px-4 py-2 font-semibold text-sm cursor-pointer transition hover:bg-gray-100" data-id="{{ article.id }}">Edit</button>
            <button class="bg-transparent text-red-600 border border-transparent rounded px-4 py-2 font-semibold text-sm cursor-pointer transition hover:bg-red-100" data-id="{{ article.id }}">Delete</button>
          </div>
        {% endif %}
      </div>
    {% empty %}
      {% if search_query or category_filter %}
        <p>No articles found !</p>
      {% else %}
        <p>No blog posts available yet.</p>
      {% endif %}
    {% endfor %}
  </div>
</main>

<div id="addBlogModal" class="hidden fixed inset-0 w-screen h-screen bg-black/40 z-[1001] overflow-y-auto items-center justify-center p-5">
  <div class="bg-white max-w-2xl w-full m-0 p-6 rounded-lg shadow-lg relative">
    <button id="closeAddBlogModal" class="absolute top-3 right-4 text-2xl bg-none border-none cursor-pointer font-bold text-gray-500 transition hover:text-black">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Add New Blog Post</h2>
    <div id="addBlogFormContainer"></div>
    <div id="addBlogFormMsg" class="mt-3 font-semibold"></div>
  </div>
</div>

<div id="editBlogModal" class="hidden fixed inset-0 w-screen h-screen bg-black/40 z-[1001] overflow-y-auto items-center justify-center p-5">
  <div class="bg-white max-w-2xl w-full m-0 p-6 rounded-lg shadow-lg relative">
    <button id="closeEditBlogModal" class="absolute top-3 right-4 text-2xl bg-none border-none cursor-pointer font-bold text-gray-500 transition hover:text-black">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Edit Blog Post</h2>
    <div id="editBlogFormContainer"></div>
    <div id="editBlogFormMsg" class="mt-3 font-semibold"></div>
  </div>
</div>

<footer class="text-center text-gray-500 py-6 text-sm border-t border-gray-200 mt-10">
  <small>Copyright @PadelinAja. All Rights Reserved.</small>
</footer>

{% block scripts %}
<script>
    // --- Shared Helper Functions (Kept the same for consistency) ---

    function openModal(modalElement) {
        if(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex');
        }
    }
    function closeModal(modalElement) {
        if(modalElement) {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('flex');
        }
    }

    function applyTailwindToForm(formContainer) {
        formContainer.querySelectorAll('.form-group').forEach(group => {
            group.classList.add('mb-4');
        });
        formContainer.querySelectorAll('label').forEach(label => {
            label.classList.add('block', 'font-semibold', 'text-sm', 'mb-1', 'text-gray-700');
        });
        formContainer.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(input => {
            input.classList.add('w-full', 'p-2.5', 'border', 'border-gray-300', 'rounded-md', 'box-border', 'text-base', 'focus:border-purple-500', 'focus:ring', 'focus:ring-purple-200', 'focus:outline-none');
            if(input.tagName === 'SELECT') {
                input.classList.add('appearance-none', 'bg-white', 'tailwind-select-arrow'); // Using 'tailwind-select-arrow' from your working example
            }
            if(input.tagName === 'TEXTAREA') {
                input.setAttribute('rows', '6');
            }
        });
        formContainer.querySelectorAll('button[type="submit"]').forEach(button => {
            button.classList.add('w-full', 'mt-4', 'bg-purple-700', 'text-white', 'p-3', 'border-none', 'rounded-lg', 'cursor-pointer', 'font-bold', 'transition', 'hover:bg-purple-800', 'hover:-translate-y-0.5');
        });
    }

    function attachFormHandler(formContainer, msgContainer, modalInstance) {
        const form = formContainer.querySelector('form');
        if (!form) return;

        form.onsubmit = function(e) {
            e.preventDefault();
            msgContainer.textContent = '';
            const data = new FormData(form);
            const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

            fetch(form.action, { 
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                body: data
            })
            .then(response => response.json())
            .then(res => {
                if (res.success) {
                    msgContainer.style.color = '#080';
                    msgContainer.textContent = 'Success!';
                    // Reload the page to show the updated article details
                    setTimeout(() => { location.reload(); }, 1200); 
                } else {
                    msgContainer.style.color = '#b00';
                    msgContainer.textContent = 'Please correct the errors in the form.';
                    
                    if (res.errors && typeof res.errors === 'string') {
                         try {
                             const errors = JSON.parse(res.errors);
                             form.querySelectorAll('.form-error').forEach(el => el.remove()); 
                             for (const fieldName in errors) {
                                 const field = form.querySelector(`[name="${fieldName}"]`);
                                 const errorList = errors[fieldName];
                                 if (field && errorList.length > 0) {
                                     const errorEl = document.createElement('div');
                                     errorEl.className = 'form-error';
                                     errorEl.classList.add('text-red-700', 'text-sm', 'mt-1');
                                     errorEl.textContent = errorList.map(e => e.message).join(' ');
                                     field.parentNode.insertBefore(errorEl, field.nextSibling);
                                 }
                             }
                         } catch (e) {
                             msgContainer.textContent = res.errors; 
                             console.error('Could not parse form errors JSON:', e);
                         }
                    } else if (typeof res.errors === 'string') {
                        msgContainer.textContent = res.errors; 
                    }
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                msgContainer.style.color = '#b00';
                msgContainer.textContent = 'An unexpected error occurred.';
            });
        };
    }

    // --- Detail Page Logic ---
    
    document.addEventListener("DOMContentLoaded", function() {

        const editBlogModal = document.getElementById('editBlogModal');
        const closeEditBlogModal = document.getElementById('closeEditBlogModal');
        const editBlogFormContainer = document.getElementById('editBlogFormContainer');
        const editBlogFormMsg = document.getElementById('editBlogFormMsg');

        const editBtnDetail = document.getElementById('editBtnDetail');
        const deleteBtnDetail = document.getElementById('deleteBtnDetail');
        
        // --- Edit Button Handler ---
        if (editBtnDetail) {
            editBtnDetail.onclick = function(e) {
                console.log('Edit button clicked for article ID:', this.dataset.id);
                
                const articleId = this.dataset.id;
                editBlogFormContainer.innerHTML = '<p>Loading edit form...</p>';
                editBlogFormMsg.textContent = '';
                openModal(editBlogModal);

                const editUrl = "{% url 'main:ajax_edit_article' article.id %}".replace(articleId, articleId);

                fetch(editUrl, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                .then(response => {
                    if (!response.ok) {
                        // Log a detailed error if the response status is bad (e.g., 404, 500)
                        return response.text().then(text => { throw new Error(`HTTP error! status: ${response.status}. Response: ${text.substring(0, 100)}...`); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.html) {
                        editBlogFormContainer.innerHTML = data.html; 
                        attachFormHandler(editBlogFormContainer, editBlogFormMsg, editBlogModal);
                        applyTailwindToForm(editBlogFormContainer);
                    } else {
                        editBlogFormContainer.innerHTML = '<p>Sorry, edit form could not be loaded.</p>';
                        console.error("Error loading edit form HTML:", data.error || 'No HTML received');
                    }
                })
                .catch(error => {
                    console.error('Error fetching edit form:', error);
                    editBlogFormContainer.innerHTML = `<p>Error loading edit form. Please check console. Error: ${error.message}</p>`;
                });
            }
        }

        // --- Delete Button Handler ---
        if (deleteBtnDetail) {
            deleteBtnDetail.onclick = function(e) {
                console.log('Delete button clicked for article ID:', this.dataset.id);

                const articleId = this.dataset.id;
                if (confirm('Are you sure you want to delete this blog post?')) {
                    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                    
                    // **CRITICAL CHANGE: Use Django's {% url %} tag for the fetch endpoint**
                    const deleteUrl = "{% url 'main:ajax_delete_article' article.id %}".replace(articleId, articleId);

                    fetch(deleteUrl, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
                    })
                    .then(response => {
                        if (!response.ok) {
                             return response.text().then(text => { throw new Error(`HTTP error! status: ${response.status}. Response: ${text.substring(0, 100)}...`); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alert('Blog post deleted successfully!');
                            // Redirect to the article list page (assuming this URL name is correct)
                            window.location.href = "{% url 'main:article_list' %}"; 
                        } else {
                            alert('Error deleting post: ' + (data.errors || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting post:', error);
                        alert('An error occurred while deleting. Please try again. Error: ' + error.message);
                    });
                }
            }
        }

        // Close modal handlers
        if (closeEditBlogModal) closeEditBlogModal.onclick = () => { closeModal(editBlogModal); }
        window.onclick = e => {
            if (e.target == editBlogModal) closeModal(editBlogModal);
        };

    });
</script>

{% endblock scripts %}

{% endblock content %}