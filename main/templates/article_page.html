{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<style>
  select.tailwind-search-input {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
  }
</style>

<svg width="0" height="0" style="display:none;">
</svg>

<main class="max-w-6xl mx-auto py-6 px-4" role="main">

  <div class="my-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
    <h1 class="text-4xl font-bold text-black m-0">BLOGS <span class="text-purple-700">AND </span>UPDATES</h1>
    {% if user.is_authenticated %}
      <a href="#" id="addBlogBtn" class="py-3 px-6 text-base font-bold text-white bg-purple-700 rounded-lg cursor-pointer transition no-underline hover:bg-purple-800 hover:-translate-y-0.5">+ Add Blog</a>
    {% endif %}
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="blogGrid"> 
    {% for article in articles %}
      <div class="bg-white rounded-lg overflow-hidden shadow-md border border-gray-100 transition hover:-translate-y-1 hover:shadow-lg flex flex-col">
        <article class="flex flex-col flex-grow">
          <a href="{% url 'main:show_article' article.id %}"> 
            <img class="w-full h-52 object-cover" src="{{ article.image_url|default:'https://placehold.co/600x400/eee/ccc?text=Blog+Image' }}" alt="{{ article.title }}">
          </a>
          <div class="p-5 flex-grow flex flex-col">
            <h2 class="text-xl font-semibold text-black mb-2">{{ article.title }}</h2>
            <p class="text-sm text-gray-500 font-medium -mt-1 mb-3">
              {{ article.category }}
            </p>
            <p class="text-base text-gray-600 leading-relaxed line-clamp-3 mb-4 flex-grow">{{ article.content|truncatewords:30 }}</p>
            <a href="{% url 'main:show_article' article.id %}" class="text-sm font-semibold text-purple-700 no-underline transition hover:text-purple-900 mt-2">Read More â†’</a>
          </div>
        </article>
        
        {% if user.is_authenticated and article.user == user %}
          <div class="flex justify-end gap-2 px-5 py-4 border-t border-gray-100 mt-auto">
            <button class="bg-transparent text-gray-600 border border-transparent rounded px-4 py-2 font-semibold text-sm cursor-pointer transition hover:bg-gray-100" data-id="{{ article.id }}">Edit</button>
            <button class="bg-transparent text-red-600 border border-transparent rounded px-4 py-2 font-semibold text-sm cursor-pointer transition hover:bg-red-100" data-id="{{ article.id }}">Delete</button>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>No blog posts available yet.</p>
    {% endfor %}
  </div>

</main>

<div id="addBlogModal" class="hidden fixed inset-0 w-screen h-screen bg-black/40 z-[1001] overflow-y-auto items-center justify-center p-5">
  <div class="bg-white max-w-2xl w-full m-0 p-6 rounded-lg shadow-lg relative">
    <button id="closeAddBlogModal" class="absolute top-3 right-4 text-2xl bg-none border-none cursor-pointer font-bold text-gray-500 transition hover:text-black">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Add New Blog Post</h2>
    <div id="addBlogFormContainer"></div>
    <div id="addBlogFormMsg" class="mt-3 font-semibold"></div>
  </div>
</div>

<div id="editBlogModal" class="hidden fixed inset-0 w-screen h-screen bg-black/40 z-[1001] overflow-y-auto items-center justify-center p-5">
  <div class="bg-white max-w-2xl w-full m-0 p-6 rounded-lg shadow-lg relative">
    <button id="closeEditBlogModal" class="absolute top-3 right-4 text-2xl bg-none border-none cursor-pointer font-bold text-gray-500 transition hover:text-black">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Edit Blog Post</h2>
    <div id="editBlogFormContainer"></div>
    <div id="editBlogFormMsg" class="mt-3 font-semibold"></div>
  </div>
</div>

<footer class="text-center text-gray-500 py-6 text-sm border-t border-gray-200 mt-10">
  <small>Copyright @PadelinAja. All Rights Reserved.</small>
</footer>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    const addBlogModal = document.getElementById('addBlogModal');
    const addBlogBtn = document.getElementById('addBlogBtn'); 
    const closeAddBlogModal = document.getElementById('closeAddBlogModal');
    const addBlogFormContainer = document.getElementById('addBlogFormContainer');
    const addBlogFormMsg = document.getElementById('addBlogFormMsg');

    const editBlogModal = document.getElementById('editBlogModal');
    const closeEditBlogModal = document.getElementById('closeEditBlogModal');
    const editBlogFormContainer = document.getElementById('editBlogFormContainer');
    const editBlogFormMsg = document.getElementById('editBlogFormMsg');

    const blogGrid = document.getElementById('blogGrid');

    function openModal(modalElement) {
        if(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex');
        }
    }
    function closeModal(modalElement) {
        if(modalElement) {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('flex');
        }
    }

    if (addBlogBtn) {
        addBlogBtn.onclick = function(e) {
            e.preventDefault();
            addBlogFormContainer.innerHTML = '<p>Loading form...</p>';
            addBlogFormMsg.textContent = '';
            openModal(addBlogModal);
            
            fetch(`/ajax_article_form/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                .then(r => r.json())
                .then(data => { 
                    if(data.html) {
                        addBlogFormContainer.innerHTML = data.html; 
                        attachFormHandler(addBlogFormContainer, addBlogFormMsg, addBlogModal); 
                        applyTailwindToForm(addBlogFormContainer);
                    } else { addBlogFormContainer.innerHTML = '<p>Error: Could not load form.</p>'; }
                })
                .catch(error => { console.error('Error fetching blog form:', error); });
        }
    }

    if (blogGrid) {
        blogGrid.addEventListener('click', function(e) {
            const editButton = e.target.closest('.btn-edit-card');
            const deleteButton = e.target.closest('.btn-delete-card');

            if (deleteButton) {
                e.preventDefault(); 
                const articleId = deleteButton.dataset.id;
                if (confirm('Are you sure you want to delete this blog post?')) {
                    const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                    fetch(`/ajax_delete/article/${articleId}/`, { 
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) { location.reload(); } 
                        else { alert('Error deleting post: ' + data.errors); }
                    })
                    .catch(error => { console.error('Error deleting post:', error); });
                }
                return; 
            }

            if (editButton) {
                e.preventDefault(); 
                const articleId = editButton.dataset.id;
                editBlogFormContainer.innerHTML = '<p>Loading edit form...</p>';
                editBlogFormMsg.textContent = '';
                openModal(editBlogModal); 

                fetch(`/ajax_edit/article/${articleId}/`, { headers: {'X-Requested-With': 'XMLHttpRequest'} })
                .then(response => response.json())
                .then(data => {
                    if (data.html) {
                        editBlogFormContainer.innerHTML = data.html;
                        attachFormHandler(editBlogFormContainer, editBlogFormMsg, editBlogModal);
                        applyTailwindToForm(editBlogFormContainer);
                    } else { editBlogFormContainer.innerHTML = '<p>Sorry, edit form could not be loaded.</p>'; }
                })
                .catch(error => { console.error('Error fetching edit form:', error); });
                return; 
            }
        });
    }

    function applyTailwindToForm(formContainer) {
        formContainer.querySelectorAll('.form-group').forEach(group => {
            group.classList.add('mb-4');
        });
        formContainer.querySelectorAll('label').forEach(label => {
            label.classList.add('block', 'font-semibold', 'text-sm', 'mb-1', 'text-gray-700');
        });
        formContainer.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(input => {
            input.classList.add('w-full', 'p-2.5', 'border', 'border-gray-300', 'rounded-md', 'box-border', 'text-base', 'focus:border-purple-500', 'focus:ring', 'focus:ring-purple-200', 'focus:outline-none');
            if(input.tagName === 'SELECT') {
                input.classList.add('appearance-none', 'bg-white', 'tailwind-search-input');
            }
            if(input.tagName === 'TEXTAREA') {
                input.setAttribute('rows', '6');
            }
        });
    }

    function attachFormHandler(formContainer, msgContainer, modalInstance) {
        const form = formContainer.querySelector('form'); 
        if (!form) return;

        const submitButton = form.querySelector('button[type="submit"]');
        if(submitButton) {
            submitButton.classList.add('w-full', 'mt-4', 'bg-purple-700', 'text-white', 'p-3', 'border-none', 'rounded-lg', 'cursor-pointer', 'font-bold', 'transition', 'hover:bg-purple-800', 'hover:-translate-y-0.5');
        }

        form.onsubmit = function(e) {
            e.preventDefault();
            msgContainer.textContent = '';
            const data = new FormData(form);
            const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            fetch(form.action, { 
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                body: data
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    msgContainer.style.color = '#080';
                    msgContainer.textContent = 'Success!';
                    setTimeout(() => { location.reload(); }, 1200);
                } else {
                    msgContainer.style.color = '#b00';
                    msgContainer.textContent = 'Please correct the errors in the form.';
                    
                    if (res.errors && typeof res.errors === 'string') {
                         try { 
                            const errors = JSON.parse(res.errors); 
                            form.querySelectorAll('.form-error').forEach(el => el.remove());
                            for (const fieldName in errors) {
                                const field = form.querySelector(`[name="${fieldName}"]`);
                                const errorList = errors[fieldName];
                                if (field && errorList.length > 0) {
                                    const errorEl = document.createElement('div');
                                    errorEl.className = 'form-error';
                                    errorEl.classList.add('text-red-700', 'text-sm', 'mt-1');
                                    errorEl.textContent = errorList.map(e => e.message).join(' ');
                                    field.parentNode.insertBefore(errorEl, field.nextSibling);
                                }
                            }
                        } catch (e) { 
                             msgContainer.textContent = res.errors; 
                             console.error('Could not parse form errors JSON:', e); 
                        }
                    } else if (typeof res.errors === 'string') { 
                         msgContainer.textContent = res.errors;
                    }
                }
            })
            .catch(error => { console.error('Error submitting form:', error); });
        };
    }

    if (closeAddBlogModal) closeAddBlogModal.onclick = () => { closeModal(addBlogModal); }
    if (closeEditBlogModal) closeEditBlogModal.onclick = () => { closeModal(editBlogModal); }

    window.onclick = e => {
        if (e.target == addBlogModal) closeModal(addBlogModal);
        if (e.target == editBlogModal) closeModal(editBlogModal);
    };

});
</script>

{% endblock content %}