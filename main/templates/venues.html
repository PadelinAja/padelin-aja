{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
  .venues-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }
  
  .venues-header {
    margin-bottom: 24px;
  }
  .venues-title {
    font-size: 2.5rem;
    font-weight: 900;
    color: #2c2c2c;
    margin: 0 0 24px 0;
  }
  .venues-title span {
    color: #6A1B9A; /* Purple */
  }

  .search-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
  }
  .search-input {
    flex: 1;
    padding: 12px 16px;
    font-size: 1rem;
    border: 2px solid #6A1B9A;
    border-radius: 8px;
    min-width: 200px;
  }
  .search-input::placeholder {
    color: #aaa;
  }
  
  .search-btn, .add-btn {
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-decoration: none;
    text-align: center;
  }
  .search-btn {
    background-color: #6A1B9A;
    color: white;
  }
  .add-btn {
    background-color: #FFED2C; /* Yellow */
    color: #000;
  }

  .venues-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
    margin-top: 32px;
  }
  
  @media (max-width: 768px) {
    .venues-grid {
      grid-template-columns: 1fr;
    }
  }

  /* --- MODAL STYLES --- */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal-content {
    background: #fff;
    padding: 24px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    position: relative;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    
    /* --- EDITED: Added scrolling --- */
    max-height: 85vh;
    overflow-y: auto;
  }
  .modal-close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 1.5rem;
    font-weight: 700;
    color: #aaa;
    cursor: pointer;
    border: none;
    background: none;
  }
  .modal-content h2 {
    margin-top: 0;
    color: #6A1B9A;
  }

  /* --- MODAL FORM STYLES --- */
  .form-group {
    margin-bottom: 16px;
  }
  .form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 700;
    font-size: 0.9rem;
  }
  
  /* --- EDITED: This CSS now targets the .form-control class from forms.py --- */
  .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: 'Lato', sans-serif; /* Inherits font */
    font-size: 1rem;
    box-sizing: border-box; /* Ensures padding doesn't break width */
  }
  .form-control:focus {
    border-color: #6A1B9A;
    outline: none;
  }
  
  .form-submit-btn {
    width: 100%;
    padding: 12px;
    background: #6A1B9A;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
  }
  .form-errors {
    color: #b00;
    background: #fdd;
    border: 1px solid #b00;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 16px;
    display: none; /* Hidden by default */
    white-space: pre-wrap; /* Show line breaks in errors */
  }
</style>

<div class="venues-container">
  
  <div class="venues-header">
    <h1 class="venues-title">BOOK YOUR <span>VENUE</span> NOW</h1>
    
    <form class="search-bar" method="GET" action="{% url 'main:show_venues' %}">
      <input type="text" name="q" class="search-input" placeholder="Search for a venue name">
      <input type="text" name="location" class="search-input" placeholder="Location">
      <input type="text" name="price" class="search-input" placeholder="Price Range">
      
      <button type="submit" class="search-btn">Search Venue</button>
      
      {% if user.is_authenticated %}
        <a href="{% url 'main:ajax_venue_form' %}" class="add-btn" id="add-venue-btn-modal">
          Add Venue
        </a>
      {% endif %}
    </form>
  </div>

  <div class="venues-grid">
    {% for item in items %}
      {% include 'venue_card.html' with item=item %}
    {% empty %}
      <p>No venues found.</p>
    {% endfor %}
  </div>

</div>

<div id="venueModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close-btn" id="modal-close-btn">&times;</button>
    <h2>Add New Venue</h2>
    <div id="modal-form-container"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  
  const addVenueBtn = document.getElementById("add-venue-btn-modal");
  const modal = document.getElementById("venueModal");
  const modalFormContainer = document.getElementById("modal-form-container");
  const modalCloseBtn = document.getElementById("modal-close-btn");
  const modalTitle = modal.querySelector("h2"); // Get modal title
  const venuesGrid = document.querySelector(".venues-grid"); // Get grid container

  // Function to open the modal and load form
  function openModalWithForm(url, title = "Add New Venue", isEdit = false, venueId = null) {
      fetch(url)
        .then(response => response.text())
        .then(html => {
          modalTitle.textContent = title; // Set modal title
          modalFormContainer.innerHTML = html;
          const form = modalFormContainer.querySelector("form");
          
          // If editing, change form action URL
          if (isEdit && form) {
              form.action = `/ajax_edit/venue/${venueId}/`; // Use the ajax_edit URL
          }
          
          modal.style.display = "flex";
        });
  }

  // --- ADD VENUE MODAL ---
  if (addVenueBtn) {
    addVenueBtn.addEventListener("click", function(e) {
      e.preventDefault(); 
      openModalWithForm(this.href, "Add New Venue");
    });
  }

  // Function to close the modal
  function closeModal() {
    modal.style.display = "none";
    modalFormContainer.innerHTML = ""; 
  }

  // Close modal listeners
  modalCloseBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  // --- AJAX FORM SUBMISSION (Handles both ADD and EDIT) ---
  modalFormContainer.addEventListener("submit", function(e) {
    if (e.target.tagName === "FORM") { // Check if the target is a form
      e.preventDefault();
      
      const form = e.target;
      const url = form.action; // Action URL is now dynamic (add or edit)
      const formData = new FormData(form);
      const errorDiv = form.querySelector("#form-errors");

      fetch(url, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          // Django needs CSRF token for POST requests
          "X-CSRFToken": formData.get("csrfmiddlewaretoken") 
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeModal();
          location.reload(); 
        } else {
          errorDiv.innerHTML = data.errors.replace(/\\n/g, '<br>');
          errorDiv.style.display = "block";
        }
      })
      .catch(error => {
          console.error("Form submission error:", error);
          errorDiv.innerHTML = "An unexpected error occurred. Please try again.";
          errorDiv.style.display = "block";
      });
    }
  });

  // --- EDIT & DELETE BUTTON LISTENERS (using event delegation) ---
  if (venuesGrid) {
    venuesGrid.addEventListener("click", function(e) {
      const venueId = e.target.dataset.id;
      
      // --- HANDLE EDIT ---
      if (e.target.classList.contains("edit-btn")) {
          const editUrl = `/ajax_edit/venue/${venueId}/`; // URL to get the form JSON

          fetch(editUrl)
            .then(response => response.json()) // <-- ADDED: Parse the JSON response
            .then(data => {
                // Now use the HTML content from the JSON data
                modalTitle.textContent = "Edit Venue";
                modalFormContainer.innerHTML = data.html; // <-- CHANGED: Use data.html
                
                // Set the correct action URL for the form when submitting
                const form = modalFormContainer.querySelector("form");
                if (form) {
                    form.action = `/ajax_edit/venue/${venueId}/`; 
                }
                
                modal.style.display = "flex"; // Show the modal
            })
            .catch(error => console.error("Error fetching edit form:", error));
      }
      
      // --- HANDLE DELETE ---
      else if (e.target.classList.contains("delete-btn")) {
          if (confirm("Are you sure you want to delete this venue?")) {
              const deleteUrl = `/ajax_delete/venue/${venueId}/`;
              
              // Need CSRF token for delete POST request too
              const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

              fetch(deleteUrl, {
                  method: "POST", // Or DELETE if your view expects it
                  headers: {
                      "X-Requested-With": "XMLHttpRequest",
                      "X-CSRFToken": csrfToken
                  }
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      // Remove the card from the page
                      const cardToRemove = venuesGrid.querySelector(`.venue-card[data-id="${venueId}"]`);
                      if (cardToRemove) {
                          cardToRemove.remove();
                      }
                  } else {
                      alert("Error deleting venue: " + data.errors);
                  }
              })
              .catch(error => {
                 console.error("Delete error:", error);
                 alert("An unexpected error occurred during deletion.");
              });
          }
      }
    });
  }

});
</script>
{% endblock content %}